<!DOCTYPE html>
<html>
  <head>
    <title>Fruits - AgriMart</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <!-- Include reusable header -->
    <%- include("partials/header", { user: user }) %> <% if(products.length
    ===0){ %>
    <div class="no-product">No Fruits Available</div>
    <% } else { %>
    <div class="grid">
      <% products.forEach(product => { %>
      <div class="card">
        <img
          src="<%= product.image ? product.image.url : 'https://placehold.co/150x100' %>"
          alt="<%= product.name %>"
        />
        <p><%= product.name %> - â‚¹<%= product.price %></p>
        <a href="/product/<%= product._id %>" class="button">View Details</a><br />

<% if (product.status === 'In Stock') { %>
  <button onclick="addToCart(<%= JSON.stringify(product) %>)">
    Add to Cart
  </button>
<% } else { %>
  <button disabled style="background: gray; cursor: not-allowed;">
    Out of Stock
  </button>
<% } %>


      </div>
      <% }) %>
    </div>
    <% } %>
    <div class="cart-icon" onclick="toggleCartPopup()">
      ðŸ›’ Cart (<span id="cart-count">0</span>)
    </div>

    <div id="cart-popup">
      <h3>Your Cart</h3>
      <ul id="cart-items"></ul>
      <p>
        <strong>Total: â‚¹<span id="cart-total">0</span></strong>
      </p>
        <div style="margin-top:10px; text-align:center;">
      <button onclick="window.location.href='/user/cart'" 
              style="background:green; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;">
        Proceed
      </button>
    </div>
    </div>

    <script>
      let cart = JSON.parse(localStorage.getItem("cart")) || [];

      function addToCart(product) {
        const item = cart.find((i) => i.product.name === product.name);
        if (item) {
          item.qty++;
        } else {
          cart.push({ product, qty: 1 });
        }
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }

      function renderCart() {
        const cartItems = document.getElementById("cart-items");
        const cartTotal = document.getElementById("cart-total");
        const cartCount = document.getElementById("cart-count");
        if (!cartItems || !cartTotal || !cartCount) return;

        cartItems.innerHTML = "";
        let total = 0;
        let count = 0;

        cart.forEach((item, index) => {
          const li = document.createElement("li");
          li.innerHTML =
            `${item.product.name} - â‚¹${item.product.price} x ${item.qty}` +
            ` <button class="remove-btn" onclick="removeFromCart(${index})">X</button>`;
          cartItems.appendChild(li);
          total += item.product.price * item.qty;
          count += item.qty;
        });

        cartTotal.textContent = total;
        cartCount.textContent = count;
      }

      function toggleCartPopup() {
        const popup = document.getElementById("cart-popup");
        if (popup) {
          popup.style.display =
            popup.style.display === "none" || popup.style.display === ""
              ? "block"
              : "none";
        }
      }

      document.addEventListener("DOMContentLoaded", renderCart);
    </script>
  </body>
</html>
